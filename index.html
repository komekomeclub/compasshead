<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compass Map [ver11]</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º */
        #version-label {
            position: fixed; top: 20px; left: 20px;
            font-size: 24px; font-weight: bold; color: red;
            background-color: rgba(255,255,255,0.9);
            padding: 5px 10px; border: 2px solid red;
            z-index: 2000; pointer-events: none;
        }

        /* å…±é€šãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .round-btn {
            width: 60px; height: 60px;
            background-color: white; border: 2px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; outline: none; user-select: none;
            -webkit-tap-highlight-color: transparent; transition: all 0.3s;
        }

        /* 1. å·¦ç«¯ï¼šã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ï¼ˆé’ï¼‰ */
        #compass-btn {
            position: fixed; left: 20px; top: 50%;
            transform: translateY(-50%);
        }
        #compass-btn.active {
            background-color: #007bff; border-color: #0056b3; color: white;
            box-shadow: 0 0 15px #007bff;
        }

        /* 2. å·¦ä¸‹ï¼šå¤•æ—¥ãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
        #sunset-btn {
            position: fixed; left: 20px; bottom: 40px;
        }
        #sunset-btn.active {
            background-color: orange; border-color: #d35400; color: white;
            box-shadow: 0 0 15px orange;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
        #debug-info {
            position: fixed; bottom: 10px; right: 10px; /* ä½ç½®ã‚’å³ä¸‹ã«å¤‰æ›´ */
            background: rgba(0,0,0,0.7); color: white;
            padding: 5px; font-size: 12px; z-index: 2000;
            pointer-events: none;
            text-align: right;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="version-label">[ver11]</div>
    <div id="debug-info">Compass: ---<br>Sunset: ---</div>
    
    <button id="compass-btn" class="round-btn">ğŸ§­</button>
    <button id="sunset-btn" class="round-btn">ğŸŒ…</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>

    <script>
        // --- è¨­å®š ---
        const DECLINATION_CORRECTION = -7; // ç£åŒ—åå·®è£œæ­£

        // --- 1. åœ°å›³åˆæœŸåŒ– ---
        const map = L.map('map').setView([35.681236, 139.767125], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- å¤‰æ•° ---
        let currentLat = null;
        let currentLng = null;
        let currentMarker = null;
        
        // ã‚³ãƒ³ãƒ‘ã‚¹ç”¨ï¼ˆé’ï¼‰
        let compassLine = null;
        let isCompassActive = false;
        let lastHeading = 0;

        // å¤•æ—¥ç”¨ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
        let sunsetLine = null;
        let isSunsetActive = false;
        let sunsetAzimuth = 0; // å¤•æ—¥ã®æ–¹è§’(åº¦)

        const debugInfo = document.getElementById('debug-info');

        // --- 2. GPSå‡¦ç† ---
        function onLocationFound(e) {
            currentLat = e.coords.latitude;
            currentLng = e.coords.longitude;
            
            if (!currentMarker) {
                currentMarker = L.circleMarker([currentLat, currentLng], {
                    color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
                }).addTo(map);
                map.setView([currentLat, currentLng], 16);
            } else {
                currentMarker.setLatLng([currentLat, currentLng]);
            }
            
            // ä½ç½®ãŒå¤‰ã‚ã£ãŸã‚‰ç·šã‚’å†æç”»
            updateLines();
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onLocationFound, null, { enableHighAccuracy: true });
        }

        // åœ°å›³ã‚’å‹•ã‹ã—ãŸã¨ãã‚‚ç·šã‚’å†è¨ˆç®—ã—ã¦æç”»
        map.on('move', () => {
            if (currentLat) updateLines();
        });

        function updateLines() {
            if (isCompassActive) drawCompassLine(lastHeading);
            if (isSunsetActive) drawSunsetLine();
        }

        // --- 3. ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³ï¼ˆé’ï¼‰ã®å‡¦ç† ---
        const compassBtn = document.getElementById('compass-btn');

        compassBtn.addEventListener('click', async () => {
            // iOS Permission
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') return;
                } catch (e) {}
            }

            isCompassActive = !isCompassActive;

            if (isCompassActive) {
                compassBtn.classList.add('active');
                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', handleOrientation);
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
                if (currentLat) drawCompassLine(lastHeading);
            } else {
                compassBtn.classList.remove('active');
                if ('ondeviceorientationabsolute' in window) {
                    window.removeEventListener('deviceorientationabsolute', handleOrientation);
                } else {
                    window.removeEventListener('deviceorientation', handleOrientation);
                }
                if (compassLine) {
                    map.removeLayer(compassLine);
                    compassLine = null;
                }
                updateDebug();
            }
        });

        function handleOrientation(event) {
            let heading = 0;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.absolute === true || event.alpha !== null) {
                heading = 360 - event.alpha;
            }

            heading += DECLINATION_CORRECTION;
            if (heading < 0) heading += 360;
            if (heading >= 360) heading -= 360;

            lastHeading = heading;
            drawCompassLine(heading);
            updateDebug();
        }

        // --- 4. å¤•æ—¥ãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ã®å‡¦ç† ---
        const sunsetBtn = document.getElementById('sunset-btn');

        sunsetBtn.addEventListener('click', () => {
            if (!currentLat || !currentLng) {
                alert("ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„");
                return;
            }

            isSunsetActive = !isSunsetActive;

            if (isSunsetActive) {
                sunsetBtn.classList.add('active');
                // ä»Šæ—¥ã®æ—¥ä»˜ã§å¤•æ—¥ã®ä½ç½®ã‚’è¨ˆç®—
                calculateSunset();
                drawSunsetLine();
            } else {
                sunsetBtn.classList.remove('active');
                if (sunsetLine) {
                    map.removeLayer(sunsetLine);
                    sunsetLine = null;
                }
                updateDebug();
            }
        });

        // å¤ªé™½ã®ä½ç½®ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateSunset() {
            const now = new Date();
            // SunCalcã§ä»Šæ—¥ã®å¤•æ—¥(sunset)ã®æ™‚é–“ã‚’å–å¾—
            const times = SunCalc.getTimes(now, currentLat, currentLng);
            
            // å¤•æ—¥ã®æ™‚é–“ã®ã€å¤ªé™½ã®ä½ç½®æƒ…å ±ã‚’å–å¾—
            // â€»ã‚‚ã—ã€Œã™ã§ã«æ—¥ãŒæ²ˆã‚“ã§ã„ã‚‹ã€å ´åˆã§ã‚‚ã€ä»Šæ—¥ã®å¤•æ—¥ã®æ–¹è§’ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™
            const sunsetPos = SunCalc.getPosition(times.sunset, currentLat, currentLng);
            
            // SunCalcã®æ–¹è§’(azimuth)ã¯ã€Œå—=0, è¥¿=æ­£, æ±=è² ã€ã®ãƒ©ã‚¸ã‚¢ãƒ³ã§è¿”ã£ã¦ãã‚‹
            // ã“ã‚Œã‚’åœ°å›³ç”¨ï¼ˆåŒ—=0, æ™‚è¨ˆå›ã‚Šï¼‰ã®åº¦æ•°(degree)ã«å¤‰æ›
            // å—(0) -> 180åº¦, è¥¿(PI/2) -> 270åº¦
            const azimuthRad = sunsetPos.azimuth;
            let azimuthDeg = (azimuthRad * 180 / Math.PI) + 180;
            
            sunsetAzimuth = azimuthDeg;
            updateDebug();
        }


        // --- 5. æç”»å‡¦ç† ---
        
        // ç·šã®é•·ã•ã‚’è¨ˆç®—ã™ã‚‹å…±é€šé–¢æ•°
        function getLineLengthKm() {
            const centerLatLng = map.getCenter();
            const cornerLatLng = map.getBounds().getNorthEast();
            const distMeters = map.distance(centerLatLng, cornerLatLng);
            return (distMeters * 2) / 1000; // km
        }

        // çµ‚ç‚¹åº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹å…±é€šé–¢æ•°
        function calculateEndLatLng(startLat, startLng, heading, lengthKm) {
            const headingRad = heading * (Math.PI / 180);
            const dy = (lengthKm / 111) * Math.cos(headingRad);
            const dx = (lengthKm / (111 * Math.cos(startLat * Math.PI / 180))) * Math.sin(headingRad);
            return [startLat + dy, startLng + dx];
        }

        // ã‚³ãƒ³ãƒ‘ã‚¹ã®ç·šï¼ˆé’ï¼‰ã‚’æã
        function drawCompassLine(heading) {
            if (currentLat === null || currentLng === null) return;
            
            const lengthKm = getLineLengthKm();
            const endPos = calculateEndLatLng(currentLat, currentLng, heading, lengthKm);

            const latlngs = [[currentLat, currentLng], endPos];

            if (compassLine) map.removeLayer(compassLine);

            compassLine = L.polyline(latlngs, {
                color: 'blue', weight: 5, opacity: 0.7
            }).addTo(map);
        }

        // å¤•æ—¥ã®ç·šï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ã‚’æã
        function drawSunsetLine() {
            if (currentLat === null || currentLng === null) return;

            const lengthKm = getLineLengthKm();
            const endPos = calculateEndLatLng(currentLat, currentLng, sunsetAzimuth, lengthKm);

            const latlngs = [[currentLat, currentLng], endPos];

            if (sunsetLine) map.removeLayer(sunsetLine);

            sunsetLine = L.polyline(latlngs, {
                color: 'orange', weight: 5, opacity: 0.8, dashArray: '10, 10' // å°‘ã—ç ´ç·šã«ã—ã¦åŒºåˆ¥
            }).addTo(map);
        }

        function updateDebug() {
            let text = "";
            text += `Compass: ${isCompassActive ? Math.round(lastHeading) + 'Â°' : 'OFF'}<br>`;
            text += `Sunset: ${isSunsetActive ? Math.round(sunsetAzimuth) + 'Â°' : 'OFF'}`;
            debugInfo.innerHTML = text;
        }
    </script>
</body>
</html>
