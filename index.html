<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compass Map [ver6]</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #eee; }
        
        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠ */
        #map { 
            width: 100vw; 
            height: 100vh; 
            z-index: 1; 
            /* å›è»¢æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
            transition: transform 0.1s linear; 
        }

        /* --- UIãƒ‘ãƒ¼ãƒ„ï¼ˆåœ°å›³ã®å¤–ã«é…ç½®ã—ã¦å›è»¢ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰ --- */

        /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º */
        #version-label {
            position: fixed; top: 20px; left: 20px;
            font-size: 24px; font-weight: bold; color: red;
            background-color: rgba(255,255,255,0.9);
            padding: 5px 10px; border: 2px solid red;
            z-index: 2000; pointer-events: none;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */
        #debug-info {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); color: white;
            padding: 5px; font-size: 12px; z-index: 2000;
            pointer-events: none;
        }

        /* 1. å·¦ã®ä¸¸ã„ãƒœã‚¿ãƒ³ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ON/OFF & ç·šæç”»ï¼‰ */
        #compass-btn {
            position: fixed; left: 20px; top: 50%;
            transform: translateY(-50%);
            width: 60px; height: 60px;
            background-color: white; border: 2px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; outline: none; user-select: none;
            -webkit-tap-highlight-color: transparent; transition: all 0.3s;
        }
        #compass-btn.active {
            background-color: orange; border-color: #d35400; color: white;
            box-shadow: 0 0 15px orange;
        }

        /* 2. å³ä¸‹ã®é’ã„ãƒœã‚¿ãƒ³ï¼ˆåœ°å›³å›è»¢ãƒ¢ãƒ¼ãƒ‰ï¼‰ */
        #rotate-btn {
            position: fixed; right: 20px; bottom: 40px;
            width: 60px; height: 60px;
            background-color: white; border: 2px solid #ccc;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; outline: none; user-select: none;
            -webkit-tap-highlight-color: transparent; transition: all 0.3s;
        }
        /* é’ã„ãƒœã‚¿ãƒ³ãŒONã®æ™‚ */
        #rotate-btn.active {
            background-color: #007bff; border-color: #0056b3; color: white;
            box-shadow: 0 0 15px #007bff;
        }
        
        /* ç”»é¢ä¸­å¤®ã«åå­—ã‚’è¡¨ç¤ºï¼ˆä¸­å¿ƒãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ï¼‰ */
        #crosshair {
            position: fixed; top: 50%; left: 50%;
            width: 20px; height: 20px;
            margin-left: -10px; margin-top: -10px;
            pointer-events: none; z-index: 1500;
        }
        #crosshair::before, #crosshair::after {
            content: ''; position: absolute; background: rgba(0,0,0,0.5);
        }
        #crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        #crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }

    </style>
</head>
<body>

    <div id="version-label">[ver6]</div>
    <div id="debug-info">Angle: ---</div>
    <div id="crosshair"></div>

    <button id="compass-btn">ğŸ§­</button>
    
    <button id="rotate-btn">ğŸ”„</button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- è¨­å®š ---
        const DECLINATION_CORRECTION = -7; // åè§’è£œæ­£

        // --- 1. åœ°å›³åˆæœŸåŒ– ---
        // zoomControl: false ã«ã—ã¦ã€å›è»¢æ™‚ã«é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã—ã¾ã™ï¼ˆå¿…è¦ãªã‚‰trueã«ï¼‰
        const map = L.map('map', { zoomControl: false }).setView([35.681236, 139.767125], 16);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let currentLat = null;
        let currentLng = null;
        let currentMarker = null;
        let directionLine = null;
        
        let isCompassActive = false; // å·¦ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
        let isMapRotating = false;   // å³ä¸‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
        let lastHeading = 0;

        // --- 2. GPSå‡¦ç† ---
        function onLocationFound(e) {
            currentLat = e.coords.latitude;
            currentLng = e.coords.longitude;
            
            // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
            if (!currentMarker) {
                currentMarker = L.circleMarker([currentLat, currentLng], {
                    color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 10
                }).addTo(map);
                map.setView([currentLat, currentLng], 16);
            } else {
                currentMarker.setLatLng([currentLat, currentLng]);
            }

            // å›è»¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯å¸¸ã«ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç¶­æŒã™ã‚‹
            if (isMapRotating) {
                map.setView([currentLat, currentLng], map.getZoom(), { animate: false });
            }

            if (isCompassActive) drawCompassLine(lastHeading);
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onLocationFound, null, { enableHighAccuracy: true });
        }
        
        // åœ°å›³æ“ä½œæ™‚ã®å†æç”»
        map.on('move', () => {
            if (isCompassActive && currentLat) drawCompassLine(lastHeading);
        });


        // --- 3. ãƒœã‚¿ãƒ³ã®å‡¦ç† ---
        const compassBtn = document.getElementById('compass-btn');
        const rotateBtn = document.getElementById('rotate-btn');
        const debugInfo = document.getElementById('debug-info');
        const mapDiv = document.getElementById('map');

        // å·¦ãƒœã‚¿ãƒ³ï¼šã‚³ãƒ³ãƒ‘ã‚¹ç·šã¨ã‚»ãƒ³ã‚µãƒ¼ã®é–‹å§‹
        compassBtn.addEventListener('click', async () => {
            // iOS Permission Request
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response !== 'granted') return;
                } catch (e) {}
            }

            isCompassActive = !isCompassActive;
            
            if (isCompassActive) {
                compassBtn.classList.add('active');
                startSensor();
            } else {
                compassBtn.classList.remove('active');
                // å›è»¢ãƒ¢ãƒ¼ãƒ‰ã‚‚ä¸€ç·’ã«OFFã«ã™ã‚‹ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
                if (isMapRotating) toggleRotateMode();
                stopSensor();
                if (directionLine) {
                    map.removeLayer(directionLine);
                    directionLine = null;
                }
            }
        });

        // å³ä¸‹ãƒœã‚¿ãƒ³ï¼šåœ°å›³å›è»¢ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        rotateBtn.addEventListener('click', () => {
            if (!isCompassActive) {
                alert("å…ˆã«å·¦ã®ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³(ğŸ§­)ã‚’ONã«ã—ã¦ãã ã•ã„");
                return;
            }
            toggleRotateMode();
        });

        function toggleRotateMode() {
            isMapRotating = !isMapRotating;
            
            if (isMapRotating) {
                rotateBtn.classList.add('active');
                // ç¾åœ¨åœ°ã‚’å¼·åˆ¶çš„ã«ç”»é¢ä¸­å¤®ã¸
                if(currentLat) map.setView([currentLat, currentLng], map.getZoom());
                rotateBtn.innerText = "â¬†ï¸"; // ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
            } else {
                rotateBtn.classList.remove('active');
                // å›è»¢ã‚’æˆ»ã™
                mapDiv.style.transform = `rotate(0deg)`;
                rotateBtn.innerText = "ğŸ”„";
            }
        }

        // --- 4. ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† ---
        function startSensor() {
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function stopSensor() {
            if ('ondeviceorientationabsolute' in window) {
                window.removeEventListener('deviceorientationabsolute', handleOrientation);
            } else {
                window.removeEventListener('deviceorientation', handleOrientation);
            }
            debugInfo.innerText = "Angle: ---";
        }

        function handleOrientation(event) {
            let heading = 0;
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } else if (event.absolute === true || event.alpha !== null) {
                heading = 360 - event.alpha;
            }

            heading += DECLINATION_CORRECTION;
            if (heading < 0) heading += 360;
            if (heading >= 360) heading -= 360;

            lastHeading = heading;
            debugInfo.innerText = `Angle: ${Math.round(heading)}Â°`;
            
            // ç·šã‚’æç”»
            drawCompassLine(heading);

            // â˜…åœ°å›³å›è»¢å‡¦ç†ï¼ˆã“ã“ãŒVer6ã®è‚ï¼‰
            if (isMapRotating) {
                // ã‚¹ãƒãƒ›ãŒå‘ã„ã¦ã„ã‚‹æ–¹è§’(heading)ã‚’ã€ç”»é¢ã®ä¸Š(0åº¦)ã«æŒã£ã¦ããŸã„
                // ã¤ã¾ã‚Šã€åœ°å›³å…¨ä½“ã‚’ -heading åº¦ å›è»¢ã•ã›ã‚Œã°ã‚ˆã„
                mapDiv.style.transform = `rotate(-${heading}deg)`;
            }
        }


        // --- 5. æç”»å‡¦ç† ---
        function drawCompassLine(heading) {
            if (currentLat === null || currentLng === null) return;
            
            const centerLatLng = map.getCenter();
            const cornerLatLng = map.getBounds().getNorthEast();
            const distMeters = map.distance(centerLatLng, cornerLatLng);
            const lengthKm = (distMeters * 2) / 1000;

            const headingRad = heading * (Math.PI / 180);
            const dy = (lengthKm / 111) * Math.cos(headingRad);
            const dx = (lengthKm / (111 * Math.cos(currentLat * Math.PI / 180))) * Math.sin(headingRad);

            const latlngs = [
                [currentLat, currentLng],
                [currentLat + dy, currentLng + dx]
            ];

            if (directionLine) map.removeLayer(directionLine);

            directionLine = L.polyline(latlngs, {
                color: 'orange', weight: 5, opacity: 0.7
            }).addTo(map);
        }
    </script>
</body>
</html>
